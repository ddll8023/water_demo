# 前端核心组件使用说明

本文档旨在说明项目中核心通用组件的使用方法和注意事项，特别是针对开发过程中遇到的数据同步问题进行深入解析，以避免重复踩坑。

---

## 组件概览

### 1. 通用组件 (`/Common`)

- `CommonForm.vue`: 由 JSON 配置驱动的动态表单，用于快速生成包含数据绑定、布局和验证的表单。
- `FormItem.vue`: `CommonForm`的子组件，根据配置动态渲染不同类型的表单控件。
- `CommonSearch.vue`: 提供统一的搜索栏 UI，支持多种字段类型和布局。
- `CommonTable.vue`: 自定义实现的响应式表格组件，用于展示和操作数据。
- `CustomButton.vue`: 实现了项目中统一视觉风格的自定义按钮。
- `CustomCard.vue`: 通用卡片组件，支持灵活的头部和内容插槽，提供多种样式配置选项。
- `CustomDatePicker.vue`: 封装了 Element Plus 的日期选择器，提供了更稳定的日期处理。
- `CustomDialog.vue`: 标准化的对话框（模态框）组件，统一了样式和交互。
- `CustomInput.vue`: 自定义的文本输入框组件。
- `CustomInputNumber.vue`: 自定义的数字输入框组件。
- `CustomPagination.vue`: 自定义的分页组件。
- `CustomRadioGroup.vue`: 自定义的单选框组。
- `CustomSelect.vue`: 自定义的下拉选择器，支持远程搜索。
- `CustomSwitch.vue`: 自定义的开关组件。
- `CustomTextarea.vue`: 自定义的多行文本输入框。
- `EnhancedDateTimePicker.vue`: 增强版的日期时间范围选择器。
- `ExcelImporter.vue`: 用于从 `.xlsx` 文件导入数据的向导式弹窗组件。
- `PageHeader.vue`: 标准化的页面头部，用于显示标题和描述。
- `StatCard.vue`: 用于在仪表盘或概览页面展示关键统计数据的卡片。
- `TabSection.vue`: 用于创建标签页导航区域。

### 2. 图表组件 (`/Chart`)

- `MonitoringChart.vue`: 核心图表组件，用于展示各类监测数据的时间序列图表，支持轮播、缩放和平移。现已使用 CustomCard 组件统一卡片样式。

### 3. 布局组件 (`/Layout`)

- `AppLayout.vue`: 项目的整体布局框架，包含了侧边栏、头部和主内容区。
- `AppSidebar.vue`: 应用的左侧导航菜单栏。
- `SidebarItem.vue`: 递归组件，用于在侧边栏中渲染多级菜单项。
- `AppHeader.vue`: 应用的顶部栏，包含面包屑导航和用户菜单。
- `AppMain.vue`: 主内容区域，用于渲染路由匹配到的页面组件。

### 4. 地图组件 (`/Map`)

- `AMapContainer.vue`: 核心地图容器，基于高德地图 JS API，负责渲染地图、设备点位和管线。
- `DeviceInfoPopup.vue`: 当点击地图上的设备点位时，用于显示该设备详细信息的弹窗。
- `FacilityPanel.vue`: 地图页面左侧的设备管理面板，用于分类展示和定位所有设施与监测站。
- `RightControlPanel.vue`: 地图页面右侧的控制面板，主要用作图例说明。

### 5. 工程管理组件 (`/Engineering`)

- `FacilityManagement.vue`: 一个通用的设施管理组件，为各类工程信息（如泵站、水厂等）提供统一的增删改查界面。

### 6. 巡检管理组件 (`/Inspection`)

- `InspectionRecords.vue`: 用于管理和展示巡检记录的界面。
- `InspectionTasks.vue`: 用于管理和展示巡检任务的界面。

### 7. 预警管理组件 (`/Warning`)

- `RecordsManagement.vue`: 用于管理和展示预警记录的界面。
- `ThresholdsManagement.vue`: 用于设置和管理各项监测指标预警阈值的界面。

---

## 核心组件详解

### CustomDialog.vue

#### 组件概述

`CustomDialog.vue` 是对 Element Plus `el-dialog` 的标准化封装，统一了项目中的对话框样式、交互和页脚按钮。

#### 核心功能

- **v-model 控制显隐**: 通过 `v-model:visible` 控制对话框的显示和隐藏。
- **插槽 (Slots)**:
  - `default`: 对话框主体内容。
  - `footer`: 自定义页脚，若不提供则显示默认的“取消”和“确认”按钮。
- **异步操作支持**: `confirm` 事件触发后，对话框**不会**自动关闭。父组件必须在异步操作（如 API 请求）完成后，手动更新 `visible` 的值为 `false` 来关闭对话框。

#### 使用示例

```vue
<template>
	<CustomDialog
		:visible="dialogVisible"
		@update:visible="dialogVisible = $event"
		title="新增记录"
		:loading="isSubmitting"
		@confirm="handleConfirm"
		@cancel="handleCancel"
	>
		<!-- 对话框内容 -->
	</CustomDialog>
</template>

<script setup>
import { ref } from "vue";

const dialogVisible = ref(false);
const isSubmitting = ref(false);

const handleConfirm = async () => {
	isSubmitting.value = true;
	try {
		await api.createRecord();
		// 异步操作成功后，手动关闭对话框
		dialogVisible.value = false;
	} catch (error) {
		// 处理错误
	} finally {
		isSubmitting.value = false;
	}
};
</script>
```

---

### CustomCard.vue

#### 组件概述

`CustomCard.vue` 是一个通用的卡片容器组件，提供灵活的头部和内容插槽配置，支持多种样式变体，用于替代项目中重复的卡片样式代码。

#### 核心功能

- **插槽支持**:
  - `header`: 自定义头部内容，也可通过 `title` 属性快速设置标题。
  - `extra`: 头部右侧额外内容区域。
  - `default`: 卡片主体内容。
- **样式配置**:
  - `shadow`: 阴影效果控制 (`'always'`、`'hover'`、`'never'`、`false`)。
  - `bordered`: 是否显示边框 (默认 `true`)。
  - `hoverable`: 是否启用悬停效果 (默认 `false`)。
  - `padding`: 内边距配置 (`'none'`、`'small'`、`'normal'`、`'large'`)。
- **响应式设计**: 自动适配不同屏幕尺寸，在小屏设备上调整布局。

#### 使用示例

```vue
<template>
	<!-- 基础用法 -->
	<CustomCard title="基础卡片" :bordered="true" shadow="hover">
		<p>这是卡片的内容区域</p>
	</CustomCard>

	<!-- 自定义头部和额外内容 -->
	<CustomCard shadow="always" padding="small">
		<template #header>
			<div class="custom-header">
				<i class="fa fa-chart-line"></i>
				<span>图表标题</span>
			</div>
		</template>
		<template #extra>
			<button class="btn">操作按钮</button>
		</template>

		<!-- 主要内容 -->
		<div class="chart-content">
			<!-- 图表或其他内容 -->
		</div>
	</CustomCard>

	<!-- 无内边距配置，适用于全宽内容 -->
	<CustomCard padding="none" :hoverable="true">
		<template #header>
			<span>全宽布局卡片</span>
		</template>
		<!-- 内容会占满整个卡片区域 -->
		<div class="full-width-content">
			<!-- 轮播图、地图等需要全宽的内容 -->
		</div>
	</CustomCard>
</template>
```

#### 样式规范

- 完全使用现有的通用变量系统 (`var(--border-radius-large)`、`var(--spacing-*)` 等)。
- 无新增全局变量，符合样式规范文档要求。
- 组件内部样式对外透明，其他组件通过使用 CustomCard 组件获得一致的卡片效果。

---

### CommonForm.vue

#### 组件概述

`CommonForm.vue` 是一个由 JSON 配置驱动的动态表单组件，用于快速生成包含数据绑定、布局和验证的表单。

#### 核心功能

- **`items` 属性**: 通过一个数组配置表单项，包括类型、标签、栅格布局等。
- **`v-model` 双向绑定**: 与父组件的表单数据对象进行双向绑定。
- **统一验证**: 自动集成 Element Plus 的表单验证规则。
- **方法暴露**: 通过 `defineExpose` 暴露了 `validate`、`resetForm`、`clearValidate` 和 `formData` 等实例方法和属性。

#### **【重要】数据同步问题与正确实践**

**问题根源分析：**

在 `RecordsManagement.vue` 中遇到的“表单有数据但提交时为空”的问题，其根源在于 JavaScript 的**闭包（Closure）特性**与 Vue **`v-model` 重新赋值**机制的相互作用。

1.  **初始引用捕获**: 当父组件 (`RecordsManagement`) 创建时，其 `handleSubmit` 函数在自己的作用域闭包中捕获了对**初始 `formData` 对象**的引用。
2.  **`v-model` 行为**: `CommonForm` (子组件) 内部的数据更新后，会 `emit` 一个**全新的数据对象**。父组件上的 `v-model` 指令接收到这个新对象后，会将其**重新赋值**给 `formData` 变量。
3.  **引用断裂**: 此时，父组件的 `formData` 变量指向了一个新对象，但 `handleSubmit` 函数仍然持有对**最初那个、已经被废弃的旧对象**的引用。
4.  **最终结果**: 调用 `handleSubmit` 时，它读取的是旧对象的数据（大部分为空），而用户输入的所有数据都在新对象里，导致提交的数据不正确。

**解决方案与最佳实践：**

为确保任何时候都能获取到表单的最新数据，**禁止**在提交函数中直接依赖父组件作用域内的 `formData` 变量。

正确的做法是：通过 `ref` 获取 `CommonForm` 的组件实例，并直接从实例中暴露出的 `formData` 属性来获取当前最新的数据。

#### 正确使用示例

```vue
<template>
	<CustomDialog @confirm="handleSubmit">
		<CommonForm ref="recordFormRef" v-model="formData" :items="formItems" />
	</CustomDialog>
</template>

<script setup>
import { ref, reactive } from "vue";

const recordFormRef = ref(null); // 创建 ref 来引用 CommonForm 实例
const formData = reactive({
	/* ...initial data... */
});

const handleSubmit = async () => {
	// 1. 通过 ref 访问 CommonForm 实例并调用其 validate 方法
	const isValid = await recordFormRef.value.validate();
	if (!isValid) return;

	// 2. 【关键】直接从 CommonForm 实例获取最新的数据
	const currentFormData = recordFormRef.value.formData;

	// 3. 使用这份最新的数据进行提交
	await api.createRecord({ ...currentFormData });
};
</script>
```

---

## FormItem.vue 类型支持问题

### 问题现象

使用 `CommonForm` 时出现"未知的表单项类型"警告，字段无法正常渲染。

### 错误原因

`FormItem.vue` 只支持有限的字段类型（如 `input`、`select`、`date`、`datetime` 等基础类型），不支持复杂或自定义类型（如 `enhanced-datetime-range`）。

### 解决方案

使用 `type: 'slot'` 配置，通过插槽自定义组件渲染：

```vue
<!-- 表单字段配置 -->
const formFields = [ { prop: 'recordTime', label: '记录时间', type: 'slot', //
关键：使用 slot 类型 required: true, span: 12 } ]

<!-- 模板中添加插槽 -->
<CommonForm :items="formFields">
    <template #recordTime="{ item, formData, disabled }">
        <el-date-picker v-model="formData.recordTime" 
            type="datetime" 
            placeholder="请选择记录时间"
            format="YYYY-MM-DD HH:mm:ss" 
            value-format="YYYY-MM-DD HH:mm:ss" 
            :disabled="disabled"
            style="width: 100%" />
    </template>
</CommonForm>
```

### 适用场景

- 需要使用 FormItem.vue 未直接支持的组件
- 需要自定义组件的属性和事件处理
- 复杂的表单控件交互逻辑
