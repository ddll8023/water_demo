# 数据库设计文档

## 1. 设计说明

- **设计版本**: 2.1 - 实时监控模块扩展版
- **更新日期**: 2025 年 7 月 20 日
- **版本说明**: 本文档基于实际 SQL 实现（init-schema.sql）编写，新增了实时监控模块的流量检测功能数据库结构设计
- **数据库类型**: MySQL 8+
- **字符集**: UTF-8mb4
- **ORM 框架**: MyBatis + MyBatis-Plus
- **命名规范**:
  - 表名和字段名均使用小写字母和下划线 \_ 组成，例如 user_info。
  - 表名应能清晰表达其存储内容，尽量使用名词复数，如 users。
  - 主键统一命名为 id。
  - 外键命名为 关联表单数\_id，例如 users 表中的部门 ID 外键为 department_id。
- **外键约束说明**:
  - 外键字段在约束/索引列中标注为 `INDEX` 或 `UNIQUE`，表示已创建相应索引
  - 实际 SQL 实现中使用 `FK_{表名}_{字段名}_id` 格式作为索引命名
  - 外键关系通过字段名和注释明确表达，如 `department_id` 关联到 `departments` 表
  - 当前 SQL 实现仅创建外键字段索引，未创建真正的 FOREIGN KEY 约束
  - 如需数据完整性保护，建议后续添加 CONSTRAINT FOREIGN KEY 约束
- **通用字段**:
  - id: BIGINT, 主键, 自增。
  - created_at: DATETIME, 创建时间。
  - updated_at: DATETIME, 更新时间。
  - deleted_at: DATETIME, 软删除标记 (nullable)。

## 2. 设计原则

本数据库设计遵循以下核心原则：

1. **业务驱动原则**：数据库结构设计以实际业务需求为导向，专注于基础信息管理功能的数据需求。

2. **标准化原则**：采用统一的命名规范、字段类型和约束条件，确保数据结构的一致性和可维护性。

3. **权限控制原则**：基于 RBAC（基于角色的访问控制）模型，实现用户、角色、权限的分离管理，确保系统安全性。

4. **空间数据支持**：针对地理位置、行政区划等空间数据，采用 MySQL 空间数据类型，为地理信息功能提供基础支持。

5. **扩展性设计**：采用模块化设计思路，为系统未来的功能扩展预留接口和扩展空间。

## 3. 数据库架构

本数据库设计包含以下核心模块：

1. **基础信息管理**：包括部门、用户、角色、权限、人员、岗位、行政区划等基础信息表，构成系统的核心数据基础，支持完整的用户权限管理和组织架构管理功能。

2. **字典管理**：包括字典类型表和字典数据表，用于管理系统中的各种枚举值、配置参数和下拉选项，为系统提供统一的数据字典服务。

3. **工程信息服务**：包括泵站、监测站点、管道、村庄、水库、水厂、浮船、消毒药材等水利工程设施信息表，支持完整的工程信息管理功能。

4. **实时监控模块**：包括流量监测数据表、水质监测数据表和水情监测数据表，用于存储和管理各监测站点的实时流量、水质和水情数据，支持数据质量管控和多种采集方式。

5. **预警管理模块**：包括预警阈值设定和预警记录表，支持对监测数据进行实时预警。

6. **巡检模块**：包括巡检任务、记录及附件表，支持设施的周期性或临时性巡检管理。

## 4. 表结构设计

以下是根据需求说明书梳理出的核心业务表。

### 4.1. 基础信息管理 (Master Data)

#### departments (部门信息表)

| 字段名     | 数据类型     | 约束/索引                   | 备注                 |
| ---------- | ------------ | --------------------------- | -------------------- |
| id         | BIGINT       | PRIMARY KEY, AUTO_INCREMENT | 部门 ID              |
| name       | VARCHAR(255) | NOT NULL                    | 部门名称             |
| parent_id  | BIGINT       | INDEX                       | 父部门 ID (支持层级) |
| duty       | TEXT         |                             | 部门职责             |
| contact    | VARCHAR(255) |                             | 联系方式             |
| region_id  | BIGINT       | INDEX                       | 所属行政区域 ID      |
| is_active  | VARCHAR(50)  | DEFAULT '1'                 | 部门是否启用         |
| created_at | DATETIME     | NOT NULL                    | 创建时间             |
| updated_at | DATETIME     | NOT NULL                    | 更新时间             |
| deleted_at | DATETIME     |                             | 软删除标记           |

**设计说明**：

- 增加了 region_id 字段，关联到行政区划表，明确部门的地理管辖范围
- 完整列出了通用字段，避免使用省略记号
- **统计字段处理**: 部门人员数量等统计信息不存储在数据库中，而是通过 SQL 关联查询实时计算
  - 在应用层使用虚拟字段（@TableField(exist = false)）接收统计结果
  - 避免数据冗余和一致性问题，确保统计数据的实时性和准确性

#### users (用户信息表)

| 字段名     | 数据类型     | 约束/索引                   | 备注              |
| ---------- | ------------ | --------------------------- | ----------------- |
| id         | BIGINT       | PRIMARY KEY, AUTO_INCREMENT | 用户 ID           |
| username   | VARCHAR(100) | NOT NULL, UNIQUE            | 用户名 (用于登录) |
| password   | VARCHAR(255) | NOT NULL                    | 加密后的密码      |
| email      | VARCHAR(100) |                             | 电子邮箱          |
| role_id    | BIGINT       | INDEX                       | 角色 ID           |
| is_active  | VARCHAR(50)  | DEFAULT '1'                 | 账户是否激活      |
| last_login | DATETIME     |                             | 最后登录时间      |
| created_at | DATETIME     | NOT NULL                    | 创建时间          |
| updated_at | DATETIME     | NOT NULL                    | 更新时间          |
| deleted_at | DATETIME     |                             | 软删除标记        |

**设计说明**：

- **职责定位**：用户表专门用于系统登录账号管理，不包含业务人员信息
- **核心字段**：username, password 用于身份认证，role_id 用于权限控制
- **权限获取方式**：用户 → 角色 → 权限，采用标准 RBAC 模型
- **role_id 字段**：保留此字段用于向后兼容，新系统使用 user_roles 表实现多角色
- **多角色支持**：通过 user_roles 关联表支持一个用户拥有多个角色，权限取并集
- **与人员区别**：用户是系统操作者，人员是被管理的业务对象
- **email 字段**：用于系统通知、密码找回等系统功能

#### personnel (人员信息表)

| 字段名                | 数据类型     | 约束/索引                   | 备注               |
| --------------------- | ------------ | --------------------------- | ------------------ |
| id                    | BIGINT       | PRIMARY KEY, AUTO_INCREMENT | 人员 ID            |
| full_name             | VARCHAR(100) | NOT NULL                    | 姓名               |
| phone                 | VARCHAR(50)  |                             | 联系电话           |
| email                 | VARCHAR(100) |                             | 电子邮箱           |
| position_id           | BIGINT       | INDEX                       | 岗位 ID            |
| department_id         | BIGINT       | INDEX                       | 所属部门 ID        |
| user_id               | BIGINT       | INDEX, UNIQUE               | 关联用户 ID (可选) |
| employee_no           | VARCHAR(50)  | DEFAULT NULL                | 工号               |
| hire_date             | DATE         | DEFAULT NULL                | 入职日期           |
| work_responsibilities | TEXT         |                             | 工作职责           |
| is_active             | VARCHAR(50)  | DEFAULT '1'                 | 是否启用           |
| created_at            | DATETIME     | NOT NULL                    | 创建时间           |
| updated_at            | DATETIME     | NOT NULL                    | 更新时间           |
| deleted_at            | DATETIME     |                             | 软删除标记         |

**设计说明**：

- **职责定位**：人员表专门用于业务人员档案管理，是被管理的业务对象
- **核心关联**：通过 position_id 关联岗位，通过 department_id 关联部门
- **可选关联**：通过 user_id 关联系统用户账号（不是所有人员都需要系统账号）
- **业务特色**：包含工号、入职日期、人员状态、工作职责等完整的业务管理字段
- **工作职责字段**：work_responsibilities 使用 TEXT 类型，支持详细的职责描述（最多 500 字符限制在应用层控制）
- **状态管理**：支持双重状态控制（status 字段表示在职状态，is_active 字段表示启用状态，使用字符串类型便于扩展）
- **与用户区别**：人员是现实中的工作人员，用户是系统登录账号

#### roles (角色表)

| 字段名      | 数据类型     | 约束/索引                   | 备注                       |
| ----------- | ------------ | --------------------------- | -------------------------- |
| id          | BIGINT       | PRIMARY KEY, AUTO_INCREMENT | 角色 ID                    |
| name        | VARCHAR(100) | NOT NULL, UNIQUE            | 角色名称                   |
| description | TEXT         |                             | 角色描述                   |
| sort_order  | INT          | DEFAULT 0, INDEX            | 排序值，数值越小优先级越高 |
| created_at  | DATETIME     | NOT NULL                    | 创建时间                   |
| updated_at  | DATETIME     | NOT NULL                    | 更新时间                   |
| deleted_at  | DATETIME     |                             | 软删除标记                 |

**设计说明**：

- 新增角色表，支持系统的角色权限控制功能
- 增加 sort_order 字段，支持角色的自定义排序，便于管理界面展示
- 角色表示权限级别，系统预设四个权限级别角色（按权限大小排序）：
  - **超级管理员** (sort_order: 10)：拥有所有权限，包括系统配置、用户管理、角色管理等系统管理功能
  - **管理员** (sort_order: 20)：拥有业务管理、业务操作和数据查看权限，不能修改系统核心配置
  - **操作员** (sort_order: 30)：拥有业务操作和数据查看权限，可进行数据录入和处理
  - **只读用户** (sort_order: 40)：仅拥有数据查看权限，不能进行任何修改操作
- 权限体系采用四级权限控制：
  - **system:manage**：系统管理权限（最高级别）
  - **business:manage**：业务管理权限（高级别）
  - **business:operate**：业务操作权限（中级别）
  - **data:view**：数据查看权限（基础级别）
- 角色直接分配给用户：采用标准 RBAC 模型，实现"用户 → 角色 → 权限"的简洁权限链

#### user_roles (用户角色关联表)

| 字段名     | 数据类型 | 约束/索引                    | 备注     |
| ---------- | -------- | ---------------------------- | -------- |
| id         | BIGINT   | PRIMARY KEY, AUTO_INCREMENT  | ID       |
| user_id    | BIGINT   | NOT NULL, INDEX, FOREIGN KEY | 用户 ID  |
| role_id    | BIGINT   | NOT NULL, INDEX, FOREIGN KEY | 角色 ID  |
| created_at | DATETIME | NOT NULL                     | 创建时间 |

**设计说明**：

- 用户角色关联表实现用户与角色的多对多关系，支持一个用户拥有多个角色
- 通过复合唯一约束(uk_user_role)确保用户与角色的关联唯一性
- user_id 外键关联到 users 表，采用 CASCADE 删除策略，当删除用户时自动删除其角色关联
- role_id 外键关联到 roles 表，采用 CASCADE 删除策略，当删除角色时自动删除相关用户关联
- 支持更灵活的权限管理，用户可同时具备多种角色的权限
- 采用简化结构，仅保留必要字段，提高查询效率
- 表结构按照 MySQL 外键约束顺序设计，确保创建时不会出现引用关系错误

#### role_permissions (角色权限关联表)

| 字段名        | 数据类型 | 约束/索引                   | 备注       |
| ------------- | -------- | --------------------------- | ---------- |
| id            | BIGINT   | PRIMARY KEY, AUTO_INCREMENT | 关联 ID    |
| role_id       | BIGINT   | NOT NULL, INDEX             | 角色 ID    |
| permission_id | BIGINT   | NOT NULL, INDEX             | 权限 ID    |
| created_at    | DATETIME | NOT NULL                    | 创建时间   |
| updated_at    | DATETIME | NOT NULL                    | 更新时间   |
| deleted_at    | DATETIME |                             | 软删除标记 |

**设计说明**：

- 新增角色权限关联表，实现多对多关系
- 使用复合索引优化查询性能
- 唯一键约束设计为 `(role_id, permission_id, deleted_at)`，确保软删除记录不影响新记录的插入
- 权限分配时使用物理删除而非软删除，避免唯一约束冲突
- 支持软删除功能，符合通用字段规范

#### permissions (权限表)

| 字段名      | 数据类型     | 约束/索引                   | 备注                             |
| ----------- | ------------ | --------------------------- | -------------------------------- |
| id          | BIGINT       | PRIMARY KEY, AUTO_INCREMENT | 权限 ID                          |
| name        | VARCHAR(100) | NOT NULL                    | 权限名称                         |
| code        | VARCHAR(100) | NOT NULL, UNIQUE            | 权限编码                         |
| type        | VARCHAR(50)  | NOT NULL                    | 权限类型(MODULE/MENU/BUTTON/API) |
| parent_id   | BIGINT       | INDEX                       | 父权限 ID                        |
| description | TEXT         |                             | 权限描述                         |
| sort_order  | INT          | DEFAULT 0, INDEX            | 排序值，数值越小优先级越高       |
| created_at  | DATETIME     | NOT NULL                    | 创建时间                         |
| updated_at  | DATETIME     | NOT NULL                    | 更新时间                         |
| deleted_at  | DATETIME     |                             | 软删除标记                       |

**设计说明**：

- 权限表用于定义系统的访问权限，支持层级结构的权限管理
- 权限类型包括：MODULE（模块权限）、MENU（菜单权限）、BUTTON（按钮权限）、API（接口权限）
- 通过 parent_id 字段支持权限的层级结构，便于构建权限树
- sort_order 字段支持权限的自定义排序，便于管理界面展示
- 系统预设四个核心权限：system:manage（系统管理）、business:manage（业务管理）、business:operate（业务操作）、data:view（数据查看）

#### positions (岗位表)

| 字段名           | 数据类型     | 约束/索引                   | 备注       |
| ---------------- | ------------ | --------------------------- | ---------- |
| id               | BIGINT       | PRIMARY KEY, AUTO_INCREMENT | 岗位 ID    |
| name             | VARCHAR(100) | NOT NULL, UNIQUE            | 岗位名称   |
| description      | TEXT         |                             | 岗位描述   |
| responsibilities | TEXT         |                             | 岗位职责   |
| level            | VARCHAR(50)  |                             | 岗位级别   |
| created_at       | DATETIME     | NOT NULL                    | 创建时间   |
| updated_at       | DATETIME     | NOT NULL                    | 更新时间   |
| deleted_at       | DATETIME     |                             | 软删除标记 |

**设计说明**：

- **职责定位**：岗位表用于定义职务职责，是纯粹的业务概念，不参与权限控制
- **核心功能**：定义工作职能、职责范围和岗位级别，用于人员管理和组织架构
- **业务应用**：分配给人员，用于明确工作职责和业务分工
- **与权限解耦**：岗位不再关联角色，权限控制完全由用户的角色决定
- **系统预设岗位**：
  - **系统管理员**：负责系统维护、配置管理和技术支持
  - **业务管理员**：负责业务流程管理、监督和协调工作
  - **监测员**：负责监测数据采集、分析和异常处理
  - **巡检员**：负责现场设备巡检、维护和问题上报
  - **数据分析员**：负责数据统计分析和报表生成
- **设计优势**：岗位调整不影响系统权限，业务管理更加灵活

#### regions (行政区划表)

| 字段名     | 数据类型     | 约束/索引                   | 备注                     |
| ---------- | ------------ | --------------------------- | ------------------------ |
| id         | BIGINT       | PRIMARY KEY, AUTO_INCREMENT | 区域 ID                  |
| code       | VARCHAR(20)  | NOT NULL, UNIQUE            | 行政区划代码             |
| name       | VARCHAR(100) | NOT NULL                    | 区域名称                 |
| level      | TINYINT      | NOT NULL                    | 行政级别(省/市/县/乡/村) |
| parent_id  | BIGINT       | INDEX                       | 父级区域 ID              |
| boundary   | GEOMETRY     |                             | 行政区划边界             |
| created_at | DATETIME     | NOT NULL                    | 创建时间                 |
| updated_at | DATETIME     | NOT NULL                    | 更新时间                 |
| deleted_at | DATETIME     |                             | 软删除标记               |

**设计说明**：

- 新增行政区划表，支持"一张图"中的行政区划展示
- 使用 boundary 字段存储行政区边界的空间数据
- 符合《中华人民共和国行政区划代码》(GB/T2260-2007)标准

#### dict_types (字典类型表)

| 字段名      | 数据类型     | 约束/索引                   | 备注                       |
| ----------- | ------------ | --------------------------- | -------------------------- |
| id          | BIGINT       | PRIMARY KEY, AUTO_INCREMENT | 字典类型 ID                |
| type_code   | VARCHAR(100) | NOT NULL, UNIQUE            | 字典类型编码               |
| type_name   | VARCHAR(100) | NOT NULL                    | 字典类型名称               |
| description | TEXT         |                             | 描述信息                   |
| sort_order  | INT          | DEFAULT 0, INDEX            | 排序值，数值越小优先级越高 |
| is_active   | VARCHAR(50)  | DEFAULT '1'                 | 是否启用                   |
| created_at  | DATETIME     | NOT NULL                    | 创建时间                   |
| updated_at  | DATETIME     | NOT NULL                    | 更新时间                   |
| deleted_at  | DATETIME     |                             | 软删除标记                 |

**设计说明**：

- 字典类型表用于管理系统中的各种枚举分类，如用户状态、设备状态等
- type_code 字段作为唯一标识，用于程序中引用特定字典类型
- 支持排序功能，便于管理界面展示和程序调用时的顺序控制
- 支持启用/禁用状态，便于动态控制字典类型的可用性

#### dict_data (字典数据表)

| 字段名      | 数据类型     | 约束/索引                   | 备注                       |
| ----------- | ------------ | --------------------------- | -------------------------- |
| id          | BIGINT       | PRIMARY KEY, AUTO_INCREMENT | 字典数据 ID                |
| type_id     | BIGINT       | NOT NULL, INDEX             | 关联字典类型 ID            |
| data_label  | VARCHAR(100) | NOT NULL                    | 字典标签（显示值）         |
| data_value  | VARCHAR(100) | NOT NULL                    | 字典键值（实际值）         |
| description | TEXT         |                             | 描述信息                   |
| sort_order  | INT          | DEFAULT 0, INDEX            | 排序值，数值越小优先级越高 |
| is_active   | VARCHAR(50)  | DEFAULT '1'                 | 是否启用                   |
| created_at  | DATETIME     | NOT NULL                    | 创建时间                   |
| updated_at  | DATETIME     | NOT NULL                    | 更新时间                   |
| deleted_at  | DATETIME     |                             | 软删除标记                 |

**设计说明**：

- 字典数据表存储具体的字典项，如"启用"、"禁用"等选项值
- data_label 用于界面显示，data_value 用于程序逻辑处理
- 通过 type_id 关联到字典类型表，形成完整的字典体系
- 复合唯一索引 uk_dict_data_type_value 确保同一类型下的键值唯一性
- 支持排序和启用/禁用控制，提供灵活的字典管理功能

### 4.2. 工程信息服务 (Engineering Information Service)

#### pumping_stations (泵站信息表)

| 字段名             | 数据类型      | 约束/索引                   | 备注                                                            |
| ------------------ | ------------- | --------------------------- | --------------------------------------------------------------- |
| id                 | BIGINT        | PRIMARY KEY, AUTO_INCREMENT | 主键 ID                                                         |
| name               | VARCHAR(255)  | NOT NULL                    | 泵站名称                                                        |
| station_code       | VARCHAR(100)  | UNIQUE                      | 泵站编码                                                        |
| station_type       | VARCHAR(100)  |                             | 泵站类型（通过工程服务 API 获取类型选项）                       |
| water_project      | VARCHAR(255)  |                             | 所属供水工程                                                    |
| water_company      | VARCHAR(255)  |                             | 所属供水公司                                                    |
| longitude          | DECIMAL(10,7) |                             | 经度                                                            |
| latitude           | DECIMAL(10,7) |                             | 纬度                                                            |
| address            | VARCHAR(255)  |                             | 地址                                                            |
| operation_mode     | VARCHAR(100)  |                             | 运行方式（关联 dict_data.data_value，type_code=operation_mode） |
| unit_count         | INT           |                             | 机组数量（台）                                                  |
| design_scale       | DECIMAL(12,2) |                             | 设计规模（m³/天）                                               |
| installed_capacity | DECIMAL(12,2) |                             | 装机容量（kW）                                                  |
| lift_head          | DECIMAL(10,2) |                             | 扬程（m）                                                       |
| establishment_date | DATE          |                             | 建站年月                                                        |
| created_at         | DATETIME      | NOT NULL                    | 创建时间                                                        |
| updated_at         | DATETIME      | NOT NULL                    | 更新时间                                                        |
| deleted_at         | DATETIME      |                             | 软删除标记                                                      |

**设计说明**：

- 泵站信息表用于管理加压泵站等设施的详细档案
- station_type 和 operation_mode 字段使用数据字典，便于维护和扩展
- 包含完整的技术参数，支持工程运行管理需求

#### monitoring_stations (监测站点表)

| 字段名               | 数据类型      | 约束/索引                   | 备注                                                               |
| -------------------- | ------------- | --------------------------- | ------------------------------------------------------------------ |
| id                   | BIGINT        | PRIMARY KEY, AUTO_INCREMENT | 主键 ID                                                            |
| station_code         | VARCHAR(100)  | UNIQUE                      | 站码                                                               |
| name                 | VARCHAR(255)  | NOT NULL                    | 站名                                                               |
| water_system_name    | VARCHAR(255)  |                             | 水系名称                                                           |
| river_name           | VARCHAR(255)  |                             | 河流名称                                                           |
| monitoring_item_code | VARCHAR(50)   |                             | 监测项目码（关联 dict_data.data_value，type_code=monitoring_item） |
| admin_region_code    | VARCHAR(20)   | INDEX                       | 行政区划代码（关联 regions.code）                                  |
| establishment_date   | DATE          |                             | 设站年月                                                           |
| longitude            | DECIMAL(10,7) |                             | 经度                                                               |
| latitude             | DECIMAL(10,7) |                             | 纬度                                                               |
| remark               | TEXT          |                             | 备注                                                               |
| created_at           | DATETIME      | NOT NULL                    | 创建时间                                                           |
| updated_at           | DATETIME      | NOT NULL                    | 更新时间                                                           |
| deleted_at           | DATETIME      |                             | 软删除标记                                                         |

**设计说明**：

- 监测站点表用于管理流量站、视频站等各类监测站点
- admin_region_code 关联到 regions 表，实现行政区划管理
- monitoring_item_code 使用数据字典，支持多种监测项目类型
- 支持实时监测模块的业务需求

#### pipelines (管道信息表)

| 字段名            | 数据类型      | 约束/索引                   | 备注                                                           |
| ----------------- | ------------- | --------------------------- | -------------------------------------------------------------- |
| id                | BIGINT        | PRIMARY KEY, AUTO_INCREMENT | 主键 ID                                                        |
| pipeline_code     | VARCHAR(100)  | UNIQUE                      | 管道编码                                                       |
| name              | VARCHAR(255)  | NOT NULL                    | 管道名称                                                       |
| pipeline_type     | VARCHAR(100)  |                             | 管道类型（关联 dict_data.data_value，type_code=pipeline_type） |
| start_longitude   | DECIMAL(10,7) |                             | 起点经度                                                       |
| start_latitude    | DECIMAL(10,7) |                             | 起点纬度                                                       |
| end_longitude     | DECIMAL(10,7) |                             | 终点经度                                                       |
| end_latitude      | DECIMAL(10,7) |                             | 终点纬度                                                       |
| length            | DECIMAL(10,2) |                             | 管道长度（km）                                                 |
| diameter          | DECIMAL(8,2)  |                             | 管径（mm）                                                     |
| design_pressure   | DECIMAL(8,2)  |                             | 设计压力（MPa）                                                |
| design_flow       | DECIMAL(12,2) |                             | 设计流量（m³/h）                                               |
| burial_depth      | DECIMAL(8,2)  |                             | 埋深（m）                                                      |
| construction_date | DATE          |                             | 建设年月                                                       |
| remark            | TEXT          |                             | 备注                                                           |
| created_at        | DATETIME      | NOT NULL                    | 创建时间                                                       |
| updated_at        | DATETIME      | NOT NULL                    | 更新时间                                                       |
| deleted_at        | DATETIME      |                             | 软删除标记                                                     |

**设计说明**：

- 管道信息表用于记录供水干管、支管等管道信息
- 使用经纬度坐标精确记录起点和终点位置，支持地理信息系统
- diameter 字段改为数值类型，便于计算和统计分析
- 包含完整的技术参数，如设计压力、设计流量、埋深等
- pipeline_type 和 material 使用数据字典，支持标准化管理
- 支持供水系统的管网管理需求

#### villages (村庄信息表)

| 字段名                      | 数据类型      | 约束/索引                   | 备注                                                                      |
| --------------------------- | ------------- | --------------------------- | ------------------------------------------------------------------------- |
| id                          | BIGINT        | PRIMARY KEY, AUTO_INCREMENT | 主键 ID                                                                   |
| name                        | VARCHAR(255)  | NOT NULL                    | 村庄名称                                                                  |
| longitude                   | DECIMAL(10,7) |                             | 经度                                                                      |
| latitude                    | DECIMAL(10,7) |                             | 纬度                                                                      |
| administrative_code         | VARCHAR(20)   | INDEX                       | 行政区划代码（关联 regions.code）                                         |
| village_type                | VARCHAR(100)  |                             | 村庄类型（关联 dict_data.data_value，type_code=village_type）             |
| current_population          | INT           |                             | 现状人口（人）                                                            |
| planned_population          | INT           |                             | 规划人口（人）                                                            |
| water_supply_method         | VARCHAR(100)  |                             | 供水方式（关联 dict_data.data_value，type_code=water_supply_method）      |
| water_source                | VARCHAR(100)  |                             | 供水水源（关联 dict_data.data_value，type_code=water_source）             |
| daily_water_consumption     | DECIMAL(10,2) |                             | 日用水量（m³/天）                                                         |
| water_supply_guarantee_rate | DECIMAL(5,2)  |                             | 供水保证率（%）                                                           |
| water_quality_status        | VARCHAR(100)  |                             | 水质达标情况（关联 dict_data.data_value，type_code=water_quality_status） |
| contact_person              | VARCHAR(100)  |                             | 联系人                                                                    |
| contact_phone               | VARCHAR(50)   |                             | 联系电话                                                                  |
| remark                      | TEXT          |                             | 备注                                                                      |
| created_at                  | DATETIME      | NOT NULL                    | 创建时间                                                                  |
| updated_at                  | DATETIME      | NOT NULL                    | 更新时间                                                                  |
| deleted_at                  | DATETIME      |                             | 软删除标记                                                                |

**设计说明**：

- 村庄信息表用于管理供水范围内的村庄信息
- administrative_code 关联到 regions 表，实现行政区划管理
- 包含完整的供水管理信息，如供水方式、水源、用水量、水质等
- 支持供水范围管理和人口统计需求
- 简化了管理结构，移除了部门和负责人的直接关联，通过联系人字段记录相关信息

#### reservoirs (水库信息表)

| 字段名              | 数据类型      | 约束/索引                   | 备注                                                               |
| ------------------- | ------------- | --------------------------- | ------------------------------------------------------------------ |
| id                  | BIGINT        | PRIMARY KEY, AUTO_INCREMENT | 主键 ID                                                            |
| reservoir_code      | VARCHAR(100)  | UNIQUE                      | 水库编码                                                           |
| name                | VARCHAR(255)  | NOT NULL                    | 水库名称                                                           |
| department_id       | BIGINT        | INDEX                       | 管理部门 ID（关联 departments.id）                                 |
| manager_id          | BIGINT        | INDEX                       | 负责人 ID（关联 personnel.id）                                     |
| longitude           | DECIMAL(10,7) |                             | 经度                                                               |
| latitude            | DECIMAL(10,7) |                             | 纬度                                                               |
| location            | VARCHAR(255)  |                             | 水库所在位置                                                       |
| registration_no     | VARCHAR(100)  |                             | 水库注册登记号                                                     |
| admin_region_code   | VARCHAR(20)   | INDEX                       | 所属行政区划（关联 regions.code）                                  |
| engineering_grade   | VARCHAR(50)   |                             | 工程等级（关联 dict_data.data_value，type_code=engineering_grade） |
| engineering_scale   | VARCHAR(50)   |                             | 工程规模（关联 dict_data.data_value，type_code=engineering_scale） |
| total_capacity      | DECIMAL(12,2) |                             | 总库容（万 m³）                                                    |
| regulating_capacity | DECIMAL(12,2) |                             | 调节库容（万 m³）                                                  |
| dead_capacity       | DECIMAL(12,2) |                             | 死库容（万 m³）                                                    |
| establishment_date  | DATE          |                             | 建库年月                                                           |
| created_at          | DATETIME      | NOT NULL                    | 创建时间                                                           |
| updated_at          | DATETIME      | NOT NULL                    | 更新时间                                                           |
| deleted_at          | DATETIME      |                             | 软删除标记                                                         |

**设计说明**：

- 水库信息表用于存储水库的基本档案信息
- 包含完整的技术参数，如总库容、调节库容、死库容等
- engineering_grade 和 engineering_scale 使用数据字典，便于标准化管理
- 支持水库工程的全面信息管理

#### water_plants (水厂信息表)

| 字段名             | 数据类型      | 约束/索引                   | 备注                               |
| ------------------ | ------------- | --------------------------- | ---------------------------------- |
| id                 | BIGINT        | PRIMARY KEY, AUTO_INCREMENT | 主键 ID                            |
| plant_code         | VARCHAR(100)  | UNIQUE                      | 水厂编码                           |
| name               | VARCHAR(255)  | NOT NULL                    | 水厂名称                           |
| department_id      | BIGINT        | INDEX                       | 管理部门 ID（关联 departments.id） |
| manager_id         | BIGINT        | INDEX                       | 负责人 ID（关联 personnel.id）     |
| address            | VARCHAR(255)  |                             | 地址                               |
| management_unit    | VARCHAR(255)  |                             | 管理单位                           |
| longitude          | DECIMAL(10,7) |                             | 经度                               |
| latitude           | DECIMAL(10,7) |                             | 纬度                               |
| design_scale       | DECIMAL(12,2) |                             | 设计规模（m³/天）                  |
| supply_area        | TEXT          |                             | 供水范围（村镇）                   |
| supply_load_ratio  | DECIMAL(5,2)  |                             | 供水负荷率（%）                    |
| supply_population  | INT           |                             | 供水人口（万人）                   |
| contact_phone      | VARCHAR(50)   |                             | 联系电话                           |
| establishment_date | DATE          |                             | 建站年月                           |
| created_at         | DATETIME      | NOT NULL                    | 创建时间                           |
| updated_at         | DATETIME      | NOT NULL                    | 更新时间                           |
| deleted_at         | DATETIME      |                             | 软删除标记                         |

**设计说明**：

- 水厂信息表用于存储水厂的基础设施信息
- 包含供水范围、供水人口、负荷率等运营管理信息
- 支持水厂运行管理和供水服务统计需求

#### floating_boats (浮船信息表) - 优化后的简化结构

| 字段名            | 数据类型      | 约束/索引                   | 备注                                                           |
| ----------------- | ------------- | --------------------------- | -------------------------------------------------------------- |
| id                | BIGINT        | PRIMARY KEY, AUTO_INCREMENT | 主键 ID                                                        |
| name              | VARCHAR(255)  | NOT NULL                    | 浮船名称                                                       |
| longitude         | DECIMAL(10,7) |                             | 经度                                                           |
| latitude          | DECIMAL(10,7) |                             | 纬度                                                           |
| capacity          | DECIMAL(10,2) |                             | 抽水能力（m³/h）                                               |
| power_consumption | DECIMAL(10,2) |                             | 功率（kW）                                                     |
| pumping_status    | VARCHAR(50)   |                             | 抽水状态（关联 dict_data.data_value，type_code=device_status） |
| remark            | TEXT          |                             | 备注                                                           |
| created_at        | DATETIME      | NOT NULL                    | 创建时间                                                       |
| updated_at        | DATETIME      | NOT NULL                    | 更新时间                                                       |
| deleted_at        | DATETIME      |                             | 软删除标记                                                     |

**设计说明**：

- 浮船信息表用于管理用于取水的浮船设备
- 优化后的简化结构，移除了冗余字段，提高了性能和可维护性
- 保留核心业务字段：名称、位置信息、设备参数、状态信息
- 支持浮船设备的基本管理和状态监控需求

**优化记录**：

- 移除了 12 个冗余字段：boat_code, water_plant_id, department_id, manager_id, boat_type, boat_material, length, width, draft, power_system, operation_status, maintenance_date
- 字段数量从 22 个减少到 10 个，减少约 55%的存储空间
- 简化了表结构，提高了查询性能和维护效率

#### disinfection_materials (消毒药材表)

| 字段名            | 数据类型      | 约束/索引                   | 备注                                |
| ----------------- | ------------- | --------------------------- | ----------------------------------- |
| id                | BIGINT        | PRIMARY KEY, AUTO_INCREMENT | 主键 ID                             |
| name              | VARCHAR(255)  | NOT NULL                    | 名称                                |
| water_plant_id    | BIGINT        | INDEX                       | 所属水厂 ID（关联 water_plants.id） |
| storage_condition | VARCHAR(255)  |                             | 存储条件                            |
| production_date   | DATE          |                             | 生产日期                            |
| validity_period   | VARCHAR(100)  |                             | 有效期                              |
| quantity          | DECIMAL(10,2) |                             | 库存数量                            |
| unit              | VARCHAR(20)   |                             | 单位                                |
| remark            | TEXT          |                             | 备注                                |
| created_at        | DATETIME      | NOT NULL                    | 创建时间                            |
| updated_at        | DATETIME      | NOT NULL                    | 更新时间                            |
| deleted_at        | DATETIME      |                             | 软删除标记                          |

**设计说明**：

- 消毒药材表用于记录水厂使用的消毒药材信息
- 通过 water_plant_id 关联到水厂，实现药材库存的分水厂管理
- 包含生产日期、有效期、库存数量等库存管理信息
- 支持水厂运营管理中的药材管理需求

### 4.3. 实时监控模块 (Real-time Monitoring)

#### flow_monitoring_data (流量监测数据表)

| 字段名            | 数据类型      | 约束/索引                   | 备注                                     |
| ----------------- | ------------- | --------------------------- | ---------------------------------------- |
| id                | BIGINT        | PRIMARY KEY, AUTO_INCREMENT | 数据 ID，主键                            |
| station_id        | BIGINT        | INDEX, NULLABLE             | 监测站点 ID，关联 monitoring_stations 表 |
| monitoring_time   | DATETIME      | NOT NULL, INDEX             | 监测时间                                 |
| instant_flow      | DECIMAL(10,3) | NULLABLE                    | 瞬时流量(m³/s)                           |
| cumulative_flow   | DECIMAL(15,3) | NULLABLE                    | 累计流量(m³)                             |
| data_quality      | TINYINT       | DEFAULT 1, INDEX            | 数据质量(1:正常,2:异常,3:缺失)           |
| collection_method | VARCHAR(50)   | DEFAULT 'AUTO'              | 采集方式(AUTO:自动,MANUAL:手动)          |
| data_source       | VARCHAR(100)  | INDEX, NULLABLE             | 数据来源设备                             |
| remark            | VARCHAR(500)  | NULLABLE                    | 备注信息                                 |
| created_at        | DATETIME      | NOT NULL, INDEX             | 创建时间                                 |
| updated_at        | DATETIME      | NOT NULL                    | 更新时间                                 |
| deleted_at        | DATETIME      | NULLABLE                    | 软删除标记                               |

**索引设计：**

- `idx_station_time`: 复合索引(station_id, monitoring_time) - 优化按站点和时间的查询
- `idx_monitoring_time`: 单独时间索引 - 支持时间范围查询
- `idx_data_quality`: 数据质量索引 - 支持状态筛选
- `idx_data_source`: 数据源索引 - 支持按设备查询
- `idx_created_at`: 创建时间索引 - 支持数据管理
- `idx_quality_time`: 复合索引(data_quality, monitoring_time) - 支持质量统计查询

**外键关系：**

- `FK_flow_data_station_id`: 关联到 monitoring_stations 表，ON DELETE SET NULL ON UPDATE CASCADE

**业务特点：**

- 流量监测数据表用于存储各监测站点的流量数据
- 支持瞬时流量和累计流量的记录，满足不同业务分析需求
- 通过 station_id 关联到监测站点，确保数据的站点归属
- 数据质量字段支持数据质量管控，便于识别异常数据
- 采集方式字段区分自动采集和手动录入，支持多种数据来源
- 数据源字段记录具体的采集设备信息，便于设备管理和故障排查
- 采用软删除机制，保证历史数据的完整性
- 外键约束采用 SET NULL 策略，提高数据维护的灵活性
- 索引设计优化了时间序列查询性能，支持高频数据采集场景

#### water_quality_monitoring_data (水质监测数据表)

| 字段名            | 数据类型      | 约束/索引                   | 备注                                     |
| ----------------- | ------------- | --------------------------- | ---------------------------------------- |
| id                | BIGINT        | PRIMARY KEY, AUTO_INCREMENT | 数据 ID，主键                            |
| station_id        | BIGINT        | INDEX, NULLABLE             | 监测站点 ID，关联 monitoring_stations 表 |
| monitoring_time   | DATETIME      | NOT NULL, INDEX             | 监测时间                                 |
| water_temperature | DECIMAL(10,3) | NULLABLE                    | 水温(℃)                                  |
| turbidity         | DECIMAL(10,3) | NULLABLE                    | 浊度(NTU)                                |
| ph_value          | DECIMAL(10,3) | NULLABLE                    | PH 值                                    |
| conductivity      | DECIMAL(10,3) | NULLABLE                    | 电导率(uS/cm)                            |
| dissolved_oxygen  | DECIMAL(10,3) | NULLABLE                    | 溶解氧(mg/L)                             |
| ammonia_nitrogen  | DECIMAL(10,3) | NULLABLE                    | 氨氮(mg/L)                               |
| cod_value         | DECIMAL(10,3) | NULLABLE                    | 化学需氧量(mg/L)                         |
| residual_chlorine | DECIMAL(10,3) | NULLABLE                    | 余氯(mg/L)                               |
| data_quality      | TINYINT       | DEFAULT 1, INDEX            | 数据质量(1:正常,2:异常,3:缺失)           |
| collection_method | VARCHAR(50)   | DEFAULT 'AUTO'              | 采集方式(AUTO:自动,MANUAL:手动)          |
| data_source       | VARCHAR(100)  | INDEX, NULLABLE             | 数据来源设备                             |
| remark            | VARCHAR(500)  | NULLABLE                    | 备注信息                                 |
| created_at        | DATETIME      | NOT NULL, INDEX             | 创建时间                                 |
| updated_at        | DATETIME      | NOT NULL                    | 更新时间                                 |
| deleted_at        | DATETIME      | NULLABLE                    | 软删除标记                               |

**索引设计：**

- `idx_station_time`: 复合索引(station_id, monitoring_time) - 优化按站点和时间的查询
- `idx_monitoring_time`: 单独时间索引 - 支持时间范围查询
- `idx_data_quality`: 数据质量索引 - 支持状态筛选
- `idx_data_source`: 数据源索引 - 支持按设备查询
- `idx_created_at`: 创建时间索引 - 支持数据管理

**外键关系：**

- `FK_water_quality_data_station_id`: 关联到 monitoring_stations 表，ON DELETE SET NULL ON UPDATE CASCADE

**业务特点：**

- 水质监测数据表用于存储各监测站点的水质监测数据
- 采用水平存储模式，每条记录包含同一时间点的所有 8 种监测项目数据
- 支持 8 种水质监测项目：水温、浊度、PH 值、电导率、溶解氧、氨氮、化学需氧量、余氯
- 前端无需数据聚合，直接使用 API 返回的数据
- 查询性能更优，减少了 JOIN 操作的复杂性
- 数据结构更符合业务逻辑和前端展示需求
- 通过 station_id 关联到监测站点，确保数据的站点归属
- 数据质量字段支持数据质量管控，便于识别异常数据
- 采集方式字段区分自动采集和手动录入，支持多种数据来源
- 数据源字段记录具体的采集设备信息，便于设备管理和故障排查
- 采用软删除机制，保证历史数据的完整性
- 外键约束采用 SET NULL 策略，提高数据维护的灵活性
- 索引设计优化了时间序列查询性能，支持高频数据采集场景
- 便于后续添加新的监测项目字段，扩展性良好

#### reservoir_monitoring_data (水情监测数据表)

| 字段名            | 数据类型      | 约束/索引                   | 备注                                      |
| ----------------- | ------------- | --------------------------- | ----------------------------------------- |
| id                | BIGINT        | PRIMARY KEY, AUTO_INCREMENT | 数据 ID                                   |
| station_id        | BIGINT        | INDEX, NULLABLE             | 监测站点 ID (关联 monitoring_stations 表) |
| monitoring_time   | DATETIME      | NOT NULL, INDEX             | 监测时间                                  |
| water_level       | DECIMAL(10,3) | NULLABLE                    | 水位高度(m)                               |
| storage_capacity  | DECIMAL(15,3) | NULLABLE                    | 蓄水量(10⁴m³)                             |
| flood_limit_diff  | DECIMAL(10,3) | NULLABLE                    | 超汛限(m)                                 |
| inflow            | DECIMAL(10,3) | NULLABLE                    | 入库流量(m³/s)                            |
| outflow           | DECIMAL(10,3) | NULLABLE                    | 出库流量(m³/s)                            |
| data_quality      | TINYINT       | DEFAULT 1, INDEX            | 数据质量(1:正常,2:异常,3:缺失)            |
| collection_method | VARCHAR(50)   | DEFAULT 'AUTO'              | 采集方式(AUTO:自动,MANUAL:手动)           |
| data_source       | VARCHAR(100)  | INDEX, NULLABLE             | 数据来源设备                              |
| remark            | VARCHAR(500)  | NULLABLE                    | 备注信息                                  |
| created_at        | DATETIME      | NOT NULL, INDEX             | 创建时间                                  |
| updated_at        | DATETIME      | NOT NULL                    | 更新时间                                  |
| deleted_at        | DATETIME      | NULLABLE                    | 软删除标记                                |

**索引设计：**

- `idx_station_time`: 复合索引(station_id, monitoring_time) - 优化按站点和时间的查询
- `idx_monitoring_time`: 单独时间索引 - 支持时间范围查询
- `idx_data_quality`: 数据质量索引 - 支持状态筛选
- `idx_data_source`: 数据源索引 - 支持按设备查询
- `idx_created_at`: 创建时间索引 - 支持数据管理
- `idx_quality_time`: 复合索引(data_quality, monitoring_time) - 支持质量统计查询

**外键关系：**

- `FK_reservoir_data_station_id`: 关联到 monitoring_stations 表，ON DELETE SET NULL ON UPDATE CASCADE

**业务特点：**

- 水情监测数据表用于存储水情的水位、蓄水量、超汛限、入库流量、出库流量等关键监测数据
- 通过 station_id 关联到监测站点，确保数据的站点归属
- 支持水库安全运行管理的数据需求，如水位监控、蓄水量统计、入出库流量平衡分析等
- 超汛限字段记录水位与汛限水位的差值，负值表示水位低于汛限水位
- 数据质量字段支持数据质量管控，便于识别异常数据
- 采集方式字段区分自动采集和手动录入，支持多种数据来源
- 数据源字段记录具体的采集设备信息，便于设备管理和故障排查
- 采用软删除机制，保证历史数据的完整性
- 外键约束采用 SET NULL 策略，提高数据维护的灵活性
- 索引设计优化了时间序列查询性能，支持高频数据采集场景
- 与现有监测数据表保持一致的设计风格，便于统一管理和维护

### 4.4. 预警管理模块

#### warning_thresholds (预警指标设定表)

预警指标设定表用于管理各监测点的预警阈值配置。

| 字段名            | 数据类型 | 长度 | 是否为空 | 默认值         | 说明                                                |
| ----------------- | -------- | ---- | -------- | -------------- | --------------------------------------------------- |
| id                | bigint   | -    | NO       | AUTO_INCREMENT | 主键 ID                                             |
| station_name      | varchar  | 255  | NO       | -              | 测点名称                                            |
| monitoring_item   | varchar  | 50   | NO       | -              | 监测项（关联 dict_data，type_code=monitoring_item） |
| upper_upper_limit | decimal  | 10,2 | YES      | NULL           | 上上限                                              |
| upper_limit       | decimal  | 10,2 | YES      | NULL           | 上限                                                |
| lower_limit       | decimal  | 10,2 | YES      | NULL           | 下限                                                |
| lower_lower_limit | decimal  | 10,2 | YES      | NULL           | 下下限                                              |
| unit              | varchar  | 20   | YES      | NULL           | 单位                                                |
| is_active         | varchar  | 50   | YES      | '1'            | 是否启用                                            |
| created_at        | datetime | -    | NO       | -              | 创建时间                                            |
| updated_at        | datetime | -    | NO       | -              | 更新时间                                            |
| deleted_at        | datetime | -    | YES      | NULL           | 软删除标记                                          |

**索引设计：**

- PRIMARY KEY (`id`)
- KEY `idx_station_name` (`station_name`)
- KEY `idx_monitoring_item` (`monitoring_item`)
- KEY `idx_is_active` (`is_active`)

#### warning_records (预警信息记录表)

预警信息记录表用于记录和处理预警事件的完整生命周期。

**持续时长计算逻辑：**

- 持续时长（duration）字段为非数据库字段，通过 SQL 计算得出
- 对于已解除的预警：duration = |resolved_at - occurred_at|
- 对于进行中的预警：duration = |当前时间 - occurred_at|
- 使用 ABS 函数确保时长始终为正数，即使 occurred_at 为未来时间也能正确显示
- 格式为"X 小时 Y 分钟"

| 字段名           | 数据类型 | 长度 | 是否为空 | 默认值         | 说明                                                |
| ---------------- | -------- | ---- | -------- | -------------- | --------------------------------------------------- |
| id               | bigint   | -    | NO       | AUTO_INCREMENT | 主键 ID                                             |
| warning_location | varchar  | 255  | NO       | -              | 预警地点                                            |
| warning_type     | varchar  | 100  | NO       | -              | 预警类型（水位、流量、水质等）                      |
| warning_level    | varchar  | 50   | NO       | -              | 预警等级（关联 dict_data，type_code=warning_level） |
| warning_content  | text     | -    | NO       | -              | 预警内容                                            |
| warning_status   | varchar  | 50   | YES      | '进行中'       | 预警状态（进行中、已解除）                          |
| project_name     | varchar  | 255  | YES      | NULL           | 所属工程                                            |
| occurred_at      | datetime | -    | NO       | -              | 发生时间（应用层验证：不能设置为未来时间）          |
| resolved_at      | datetime | -    | YES      | NULL           | 解除时间                                            |
| threshold_id     | bigint   | -    | YES      | NULL           | 关联预警指标 ID                                     |
| created_at       | datetime | -    | NO       | -              | 创建时间                                            |
| updated_at       | datetime | -    | NO       | -              | 更新时间                                            |
| deleted_at       | datetime | -    | YES      | NULL           | 软删除标记                                          |

**索引设计：**

- PRIMARY KEY (`id`)
- KEY `idx_warning_location` (`warning_location`)
- KEY `idx_warning_type` (`warning_type`)
- KEY `idx_warning_level` (`warning_level`)
- KEY `idx_warning_status` (`warning_status`)
- KEY `idx_occurred_at` (`occurred_at`)
- KEY `FK_warning_records_threshold_id` (`threshold_id`)

**数据验证规则：**

- `occurred_at` 字段在应用层使用 `@PastOrPresent` 验证注解，确保发生时间不能设置为未来时间
- 持续时长计算使用绝对值函数，确保即使数据异常也能正确显示时长

### 4.5. 巡检模块

#### inspection_tasks (巡检任务表)

| 字段名         | 数据类型     | 约束/索引                   | 备注                                                                          |
| -------------- | ------------ | --------------------------- | ----------------------------------------------------------------------------- |
| id             | BIGINT       | PRIMARY KEY, AUTO_INCREMENT | 主键 ID                                                                       |
| title          | VARCHAR(255) | NOT NULL                    | 任务标题                                                                      |
| facility_type  | VARCHAR(100) | NOT NULL, INDEX             | 设施类型（通过工程服务 API 获取类型选项）                                     |
| facility_id    | BIGINT       | NOT NULL, INDEX             | 设施 ID（跨表引用不同业务表的主键，不加外键约束）                             |
| frequency      | VARCHAR(50)  | NULLABLE                    | 巡检频次（字典 `inspection_frequency`：daily/weekly/monthly/...）             |
| content        | TEXT         | NULLABLE                    | 巡检内容                                                                      |
| assignee_id    | BIGINT       | INDEX                       | 责任人 ID（关联 `personnel.id`）                                              |
| status         | VARCHAR(50)  | DEFAULT 'PENDING', INDEX    | 任务状态（字典 `inspection_status`：PENDING/IN_PROGRESS/COMPLETED/EXCEPTION） |
| scheduled_date | DATE         | NULLABLE, INDEX             | 计划执行日期                                                                  |
| created_at     | DATETIME     | NOT NULL                    | 创建时间                                                                      |
| updated_at     | DATETIME     | NOT NULL                    | 更新时间                                                                      |
| deleted_at     | DATETIME     | NULLABLE                    | 软删除标记                                                                    |

**设计说明**：

- 采用 `facility_type + facility_id` 的通用设施引用模型，避免跨表外键耦合。
- 通过状态与计划日期支撑任务计划与闭环管理。
- 关键筛选字段均建索引以保障查询性能。

#### inspection_records (巡检记录表)

| 字段名            | 数据类型     | 约束/索引                   | 备注                                      |
| ----------------- | ------------ | --------------------------- | ----------------------------------------- |
| id                | BIGINT       | PRIMARY KEY, AUTO_INCREMENT | 主键 ID                                   |
| task_id           | BIGINT       | INDEX                       | 关联任务 ID（可空）                       |
| inspector_id      | BIGINT       | INDEX                       | 巡检人员 ID（`personnel.id`）             |
| facility_type     | VARCHAR(100) | NOT NULL, INDEX             | 设施类型（通过工程服务 API 获取类型选项） |
| facility_id       | BIGINT       | NOT NULL, INDEX             | 设施 ID                                   |
| record_time       | DATETIME     | NOT NULL, INDEX             | 巡检时间                                  |
| device_status     | VARCHAR(50)  | NULLABLE                    | 设备状态（字典 `device_status`）          |
| issue_flag        | TINYINT(1)   | DEFAULT 0, INDEX            | 是否发现问题(0/1)                         |
| issue_description | TEXT         | NULLABLE                    | 问题描述                                  |
| resolution        | TEXT         | NULLABLE                    | 处理措施                                  |
| resolved_at       | DATETIME     | NULLABLE                    | 问题解决时间                              |
| created_at        | DATETIME     | NOT NULL                    | 创建时间                                  |
| updated_at        | DATETIME     | NOT NULL                    | 更新时间                                  |
| deleted_at        | DATETIME     | NULLABLE                    | 软删除标记                                |

**设计说明**：

- 记录与任务可解耦；独立记录支持临时上报。
- `issue_flag` 与 `task_id` 联动用于任务状态闭环（在应用层实现）。
- 通过时间、设施、是否异常等维度高效检索。

#### inspection_attachments (巡检记录附件表)

| 字段名       | 数据类型     | 约束/索引                   | 备注                                |
| ------------ | ------------ | --------------------------- | ----------------------------------- |
| id           | BIGINT       | PRIMARY KEY, AUTO_INCREMENT | 主键 ID                             |
| record_id    | BIGINT       | INDEX                       | 巡检记录 ID                         |
| file_name    | VARCHAR(255) | NOT NULL                    | 文件名                              |
| file_path    | VARCHAR(500) | NOT NULL                    | 文件访问路径（以 `/uploads/` 起始） |
| content_type | VARCHAR(100) | NULLABLE                    | 内容类型                            |
| file_size    | BIGINT       | NULLABLE                    | 文件大小（字节）                    |
| created_at   | DATETIME     | NOT NULL                    | 上传时间                            |

**设计说明**：

- 文件落地路径与静态映射 `/uploads/**` 对应，便于前端直接访问。
- 采用批量插入优化多图上传性能。

## 5. 初始化数据说明

根据 SQL 文件（init-schema.sql）的实现，系统包含以下预设的初始化数据：

### 5.1. 字典管理数据

系统预设多个字典类型及其对应的字典数据：

**字典类型数据**

| 类型编码          | 类型名称 | 描述                   | 排序值 |
| ----------------- | -------- | ---------------------- | ------ |
| user_status       | 用户状态 | 用户账户的启用禁用状态 | 10     |
| yes_no            | 是否选择 | 通用的是否选择字典     | 20     |
| device_status     | 设备状态 | 设备运行状态分类       | 30     |
| warning_level     | 预警级别 | 系统预警等级分类       | 40     |
| warning_type      | 预警类型 | 预警信息类型分类       | 41     |
| department_status | 部门状态 | 部门启用禁用状态       | 60     |
| data_source       | 数据来源 | 数据采集来源分类       | 70     |

| operation_mode | 运行方式 | 设备运行方式分类 | 90 |
| engineering_grade | 工程等级 | 水利工程等级分类 | 100 |
| engineering_scale | 工程规模 | 水利工程规模分类 | 110 |
| pipeline_type | 管道类型 | 供水管道类型分类 | 120 |
| monitoring_item | 监测项目 | 监测站点项目类型 | 130 |
| warning_status | 预警状态 | 预警信息状态分类 | 140 |
| inspection_status | 巡检状态 | 巡检任务状态分类 | 150 |
| data_quality | 数据质量 | 监测数据质量状态分类 | 160 |
| collection_method | 采集方式 | 数据采集方式分类 | 170 |
| data_source_type | 数据来源类型 | 监测数据来源设备类型分类 | 180 |
| inspection_frequency | 巡检频次 | 巡检任务频次分类 | 190 |

**字典数据详情**

1.  **用户状态 (user_status)**
    启用 (1)：用户账户启用状态
    禁用 (0)：用户账户禁用状态

2.  **是否选择 (yes_no)**
    是 (1)：肯定选择
    否 (0)：否定选择

3.  **设备状态 (device_status)**
    正常 (normal)：设备运行正常
    故障 (fault)：设备出现故障
    维护 (maintenance)：设备维护中

4.  **预警级别 (warning_level)**
    一级预警 (1)：最高级别预警
    二级预警 (2)：高级别预警
    三级预警 (3)：中级别预警
    四级预警 (4)：低级别预警

5.  **预警类型 (warning_type)**
    水位 (水位)：水位预警类型
    流量 (流量)：流量预警类型
    水质 (水质)：水质预警类型
    水温 (水温)：水温预警类型
    设备 (设备)：设备预警类型

6.  **部门状态 (department_status)**
    启用 (1)：部门启用状态
    禁用 (0)：部门禁用状态

7.  **数据来源 (data_source)**
    手动录入 (manual)：人工手动录入数据
    自动采集 (auto)：系统自动采集数据
    第三方接口 (api)：通过第三方接口获取数据

8.  **运行方式 (operation_mode)**
    1 用 1 备 (1_main_1_backup)：一台主用一台备用
    2 用 1 备 (2_main_1_backup)：两台主用一台备用
    单机运行 (single_operation)：单台设备运行
    并联运行 (parallel_operation)：多台设备并联运行

9.  **工程等级 (engineering_grade)**
    Ⅰ 等 (grade_1)：一等工程
    Ⅱ 等 (grade_2)：二等工程
    Ⅲ 等 (grade_3)：三等工程
    Ⅳ 等 (grade_4)：四等工程
    Ⅴ 等 (grade_5)：五等工程

10. **工程规模 (engineering_scale)**
    大型 (large)：大型水利工程
    中型 (medium)：中型水利工程
    小型 (small)：小型水利工程

11. **管道类型 (pipeline_type)**
    供水干管 (main_pipeline)：主要供水管道
    供水支管 (branch_pipeline)：分支供水管道
    输水管道 (transmission_pipeline)：长距离输水管道
    配水管道 (distribution_pipeline)：配水管网

12. **监测项目 (monitoring_item)**
    流量监测 (Q)：流量监测站点
    视频监控 (V)：视频监控站点
    水位监测 (H)：水位监测站点
    水质监测 (WQ)：水质监测站点
    水温监测 (WT)：水温监测项目
    浊度监测 (TU)：浊度监测项目
    PH 监测 (PH)：PH 值监测项目
    电导率监测 (EC)：电导率监测项目
    溶解氧监测 (DO)：溶解氧监测项目
    氨氮监测 (AN)：氨氮监测项目
    化学需氧量监测 (COD)：化学需氧量监测项目
    余氯监测 (RC)：余氯监测项目

13. **预警状态 (warning_status)**
    进行中 (ongoing)：预警正在进行中
    已解除 (resolved)：预警已解除

14. **巡检状态 (inspection_status)**
    待处理 (PENDING): 任务待开始
    进行中 (IN_PROGRESS): 任务正在执行
    已完成 (COMPLETED): 任务正常完成
    异常 (EXCEPTION): 任务发现异常

15. **数据质量 (data_quality)**
    正常 (1)：数据质量正常
    异常 (2)：数据质量异常
    缺失 (3)：数据缺失

16. **采集方式 (collection_method)**
    自动采集 (AUTO)：设备自动采集数据
    手动录入 (MANUAL)：人工手动录入数据

17. **数据来源类型 (data_source_type)**
    超声波流量计 (ULTRASONIC)：超声波流量计设备
    电磁流量计 (ELECTROMAGNETIC)：电磁流量计设备
    涡轮流量计 (TURBINE)：涡轮流量计设备
    孔板流量计 (ORIFICE)：孔板流量计设备
    手动测量 (MANUAL_MEASURE)：人工手动测量设备

18. **巡检频次 (inspection_frequency)**
    每日 (daily): 每天一次
    每周 (weekly): 每周一次
    每月 (monthly): 每月一次
    每季 (quarterly): 每季度一次
    紧急 (emergency): 紧急任务

### 5.2. 角色数据

系统预设四个权限级别的角色（按权限大小排序）：

| 角色名称   | 描述                                       | 排序值 |
| ---------- | ------------------------------------------ | ------ |
| 超级管理员 | 拥有系统所有权限，包括系统配置和用户管理   | 10     |
| 管理员     | 拥有业务管理权限，不能修改系统核心配置     | 20     |
| 操作员     | 拥有业务操作和数据查看权限，可进行数据录入 | 30     |
| 只读用户   | 仅有数据查看权限，不能进行任何修改操作     | 40     |

### 5.3. 岗位数据

系统预设五个标准岗位：

| 岗位名称   | 描述                             | 级别 |
| ---------- | -------------------------------- | ---- |
| 系统管理员 | 负责系统维护、配置管理和技术支持 | 高级 |
| 业务管理员 | 负责业务流程管理、监督和协调工作 | 中级 |
| 监测员     | 负责监测数据采集、分析和异常处理 | 初级 |
| 巡检员     | 负责现场设备巡检、维护和问题上报 | 初级 |
| 数据分析员 | 负责数据统计分析和报表生成       | 中级 |

### 5.4. 权限数据

系统预设四级权限体系：

| 权限编码         | 权限名称 | 权限类型 | 描述                                     |
| ---------------- | -------- | -------- | ---------------------------------------- |
| system:manage    | 系统管理 | MODULE   | 系统管理权限（包含用户、角色、权限管理） |
| business:manage  | 业务管理 | MODULE   | 业务管理权限（包含业务数据的增删改查）   |
| business:operate | 业务操作 | MODULE   | 业务操作权限（可进行数据录入和处理）     |
| data:view        | 数据查看 | MODULE   | 数据查看权限（只读访问权限）             |

### 5.5. 角色权限分配

| 角色       | 分配的权限                                                     |
| ---------- | -------------------------------------------------------------- |
| 超级管理员 | system:manage + business:manage + business:operate + data:view |
| 管理员     | business:manage + business:operate + data:view                 |
| 操作员     | business:operate + data:view                                   |
| 只读用户   | data:view                                                      |

### 5.6. 用户角色分配

系统通过 user_roles 表实现用户和角色的多对多关联，初始数据中包含：

| 用户名 | 分配的角色         | 说明                            |
| ------ | ------------------ | ------------------------------- |
| admin  | 超级管理员, 管理员 | 默认 admin 用户同时拥有两个角色 |

**设计说明**：

- 采用多角色设计，一个用户可以同时拥有多个角色
- 用户权限为所有关联角色权限的并集
- 默认 admin 用户拥有完整的系统管理权限
- 可通过用户管理界面灵活调整用户角色分配

### 5.7. 初始用户

系统创建一个默认管理员账户：

- **用户名**: admin
- **密码**: admin123（BCrypt 加密存储）
- **角色**: 超级管理员
- **关联人员**: 系统管理员（工号：EMP001）

**设计说明**：

- 以上初始化数据确保系统启动后即具备完整的权限管理体系
- 角色权限采用分级设计，权限逐级递减，确保系统安全性
- 初始用户 admin 具备最高权限，用于系统初始配置和管理
- 岗位与角色分离设计，便于灵活的人员管理和权限控制

### 5.8. 预警模块初始化数据

#### 预警指标设定数据

系统预设了 10 条预警指标设定数据，覆盖了水位、流量和多种水质监测项：

| 序号 | 测点名称   | 监测项     | 上上限 | 上限 | 下限 | 下下限 | 单位  |
| ---- | ---------- | ---------- | ------ | ---- | ---- | ------ | ----- |
| 1    | 两河口水库 | 水位       | 150    | 120  | 80   | 60     | m     |
| 2    | 流量站 1   | 流量       | 100    | 50   | -50  | -100   | m³/s  |
| 3    | 水厂       | 水温       | 40     | 30   | 20   | 10     | °     |
| 4    | 水厂       | 浊度       | 30     | 20   | 10   | 7.5    | NTU   |
| 5    | 水厂       | PH         | 10     | 8    | 6    | 4      | 无    |
| 6    | 水厂       | 电导率     | 30     | 20   | 10   | 7.5    | uS/cm |
| 7    | 水厂       | 溶解氧     | 30     | 20   | 10   | 7.5    | mg/L  |
| 8    | 水厂       | 氨氮       | 30     | 20   | 10   | 7.5    | mg/L  |
| 9    | 水厂       | 化学需氧量 | 30     | 20   | 10   | 7.5    | mg/L  |
| 10   | 水厂       | 余氯       | 100    | 10   | 0    | 0      | mg/L  |

#### 预警记录示例数据

系统预设了 5 条预警记录示例数据，用于演示预警信息处理功能：

| 序号 | 预警地点   | 预警类型 | 预警等级 | 预警内容             | 预警状态 | 所属工程           | 发生时间            | 解除时间            |
| ---- | ---------- | -------- | -------- | -------------------- | -------- | ------------------ | ------------------- | ------------------- |
| 1    | 两河口水库 | 水位     | 一般预警 | 水位超过上限 4.60 米 | 已解除   | 鄂北水资源供水工程 | 2025-02-25 08:50:00 | 2025-02-25 15:32:13 |
| 2    | 两河口水库 | 水位     | 严重预警 | 水位高于上限 9.60 米 | 已解除   | 鄂北水资源供水工程 | 2025-02-25 06:50:00 | 2025-02-25 08:43:42 |
| 3    | 两河口水库 | 水位     | 严重预警 | 水位高于上限 9.60 米 | 已解除   | 鄂北水资源供水工程 | 2025-02-25 05:45:00 | 2025-02-25 08:43:42 |
| 4    | 两河口水库 | 水位     | 严重预警 | 水位高于上限 9.60 米 | 已解除   | 鄂北水资源供水工程 | 2025-02-25 04:40:00 | 2025-02-25 08:43:43 |
| 5    | 两河口水库 | 水位     | 严重预警 | 水位高于上限 9.60 米 | 已解除   | 鄂北水资源供水工程 | 2025-02-25 03:35:00 | 2025-02-25 08:43:43 |

## 6. 总结说明

本数据库设计文档基于实际 SQL 实现（init-schema.sql）编写，确保文档与代码的完全一致性。

### 6.1. 设计特点

- **精简高效**：只包含已实现的核心功能模块，避免冗余设计
- **权限完整**：基于 RBAC 模型的完整权限管理体系
- **数据一致**：所有表结构与 SQL 文件完全匹配
- **扩展友好**：为未来功能扩展预留了良好的架构基础

### 6.2. 核心功能

当前版本包含以下核心功能：

1.  **用户管理**：完整的用户账号管理和身份认证
2.  **角色权限**：四级权限体系，支持灵活的权限控制
3.  **组织架构**：部门、岗位、人员的完整管理体系
4.  **基础数据**：行政区划等基础信息支持
5.  **字典管理**：系统枚举值和配置参数的统一管理
6.  **工程信息服务**：完整的水利工程设施信息管理
    - 泵站信息管理：加压泵站等设施的详细档案
    - 监测站点管理：流量站、视频站等各类监测站点
    - 管道信息管理：供水干管、支管等管道信息
    - 村庄信息管理：供水范围内的村庄信息
    - 水库信息管理：水库的基本档案信息
    - 水厂信息管理：水厂的基础设施信息
    - 浮船信息管理：用于取水的浮船设备
    - 消毒药材管理：水厂使用的消毒药材信息
7.  **实时监控模块**：完整的实时监测数据管理
    - 流量监测数据管理：各监测站点的实时流量数据
    - 水质监测数据管理：各监测站点的实时水质数据，支持 8 种水质监测项目
    - 水情监测数据管理：水情的水位、蓄水量、超汛限、入库流量、出库流量等数据
8.  **预警管理模块**：支持对监测数据进行实时预警，包括阈值设定和预警记录。
9.  **巡检模块**：支持设施的周期性或临时性巡检任务管理、记录上报及附件管理。

### 6.3. 技术规范

| 规范项         | 说明 -                                                                                                        |
| -------------- | ------------------------------------------------------------------------------------------------------------- |
| 数据库版本     | MySQL 8+ -                                                                                                    |
| - **字符编码** | UTF8MB4 -                                                                                                     |
| - **表数量**   | 24 个核心业务表（基础信息管理 10 个 + 工程信息服务 8 个 + 实时监控模块 3 个 + 预警管理 2 个 + 巡检模块 3 个） |
| - **初始数据** | 包含完整的角色、权限、用户、字典、监测站点、监测数据、预警阈值等初始化数据 -                                  |
| - **索引优化** | 针对查询性能进行了索引优化设计 -                                                                              |

### 6.4. 后续扩展

本版本为系统提供了完整的基础架构、工程信息服务功能和实时监控模块，后续可根据业务需求逐步扩展其他业务功能模块。
