<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demo.mapper.PositionMapper">

    <!-- 新增岗位 -->
    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO positions (name, description, responsibilities, level,
                               created_at, updated_at, deleted_at)
        VALUES (#{name}, #{description}, #{responsibilities}, #{level},
                #{createdAt}, #{updatedAt}, #{deletedAt})
    </insert>

    <!-- 更新岗位 -->
    <update id="updateById">
        UPDATE positions
        <set>
            <if test="name != null">name = #{name},</if>
            <if test="description != null">description = #{description},</if>
            <if test="responsibilities != null">responsibilities = #{responsibilities},</if>
            <if test="level != null">level = #{level},</if>
            <if test="updatedAt != null">updated_at = #{updatedAt},</if>
            <if test="deletedAt != null">deleted_at = #{deletedAt},</if>
        </set>
        WHERE id = #{id}
    </update>

    <!-- 根据ID查询岗位 -->
    <select id="selectById" resultType="com.example.demo.pojo.entity.system.Position">
        SELECT *
        FROM positions
        WHERE id = #{id}
          AND deleted_at IS NULL
    </select>

    <!-- 分页查询岗位列表（基础信息） -->
    <select id="selectPositionPageWithPersonnelCount" resultType="com.example.demo.pojo.entity.system.Position">
        SELECT id, name, description, responsibilities, level,
        created_at as createdAt, updated_at as updatedAt, deleted_at as deletedAt
        FROM positions
        WHERE deleted_at IS NULL
        <if test="keyword != null and keyword != ''">
            AND (name LIKE CONCAT('%', #{keyword}, '%')
            OR description LIKE CONCAT('%', #{keyword}, '%')
            OR responsibilities LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        ORDER BY created_at DESC
    </select>

    <!-- 检查岗位名称是否已存在 -->
    <select id="countByName" resultType="int">
        SELECT COUNT(1) FROM positions WHERE name = #{name} AND deleted_at IS NULL
        <if test="excludeId != null">AND id != #{excludeId}</if>
    </select>

    <!-- 查询岗位下的人员数量 -->
    <select id="selectPersonnelCountByPositionId" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM personnel
        WHERE position_id = #{positionId}
          AND deleted_at IS NULL
    </select>


</mapper>
