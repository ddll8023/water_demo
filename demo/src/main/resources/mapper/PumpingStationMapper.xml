<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demo.mapper.PumpingStationMapper">

    <!-- 结果映射：泵站实体 -->
    <resultMap id="PumpingStationMap" type="com.example.demo.pojo.entity.facility.PumpingStation">
        <id property="id" column="id"/>
        <result property="name" column="name"/>
        <result property="stationCode" column="station_code"/>
        <result property="stationType" column="station_type"/>
        <result property="waterProject" column="water_project"/>
        <result property="waterCompany" column="water_company"/>
        <result property="longitude" column="longitude"/>
        <result property="latitude" column="latitude"/>
        <result property="address" column="address"/>
        <result property="operationMode" column="operation_mode"/>
        <result property="unitCount" column="unit_count"/>
        <result property="designScale" column="design_scale"/>
        <result property="installedCapacity" column="installed_capacity"/>
        <result property="liftHead" column="lift_head"/>
        <result property="establishmentDate" column="establishment_date"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="deletedAt" column="deleted_at"/>
    </resultMap>

    <!-- 分页查询泵站列表（基础信息）- 用于PageHelper分页 -->
    <select id="selectPumpingStationPage" resultType="com.example.demo.pojo.entity.facility.PumpingStation">
        SELECT *
        FROM pumping_stations
        WHERE deleted_at IS NULL
        <if test="keyword != null and keyword != ''">
            AND (name LIKE CONCAT('%', #{keyword}, '%')
            OR station_code LIKE CONCAT('%', #{keyword}, '%')
            OR address LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        ORDER BY created_at DESC
    </select>

    <!-- 查询运行模式名称 -->
    <select id="selectOperationModeNameByStationId" resultType="java.lang.String">
        SELECT dict_data.data_label
        FROM pumping_stations
        LEFT JOIN dict_data ON pumping_stations.operation_mode = dict_data.data_value
        AND dict_data.type_id = (SELECT id FROM dict_types WHERE type_code = 'operation_mode' AND deleted_at IS NULL)
        AND dict_data.deleted_at IS NULL
        WHERE pumping_stations.id = #{stationId} AND pumping_stations.deleted_at IS NULL
    </select>

    <!-- 根据ID查询泵站详情（基础信息） -->
    <select id="selectPumpingStationById" resultType="com.example.demo.pojo.entity.facility.PumpingStation">
        SELECT *
        FROM pumping_stations
        WHERE id = #{id} AND deleted_at IS NULL
    </select>

    <!-- 检查泵站编码是否存在 -->
    <select id="existsByStationCode" resultType="boolean">
        SELECT COUNT(1) FROM pumping_stations
        WHERE station_code = #{stationCode} AND deleted_at IS NULL
        <if test="excludeId != null">
            AND id != #{excludeId}
        </if>
    </select>

    <!-- 检查泵站名称是否存在 -->
    <select id="existsByName" resultType="boolean">
        SELECT COUNT(1) FROM pumping_stations
        WHERE name = #{name} AND deleted_at IS NULL
        <if test="excludeId != null">
            AND id != #{excludeId}
        </if>
    </select>
    
    <!-- 根据ID查询泵站实体 -->
    <select id="selectById" resultMap="PumpingStationMap">
        SELECT * FROM pumping_stations WHERE id = #{id} AND deleted_at IS NULL
    </select>
    
    <!-- 插入泵站记录 -->
    <insert id="insertPumpingStation" parameterType="com.example.demo.pojo.entity.facility.PumpingStation" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO pumping_stations (
            name, station_code, station_type, water_project, water_company, 
            longitude, latitude, address, operation_mode, unit_count, 
            design_scale, installed_capacity, lift_head, establishment_date, 
            created_at, updated_at
        ) VALUES (
            #{name}, #{stationCode}, #{stationType}, #{waterProject}, #{waterCompany}, 
            #{longitude}, #{latitude}, #{address}, #{operationMode}, #{unitCount}, 
            #{designScale}, #{installedCapacity}, #{liftHead}, #{establishmentDate}, 
            #{createdAt}, #{updatedAt}
        )
    </insert>
    
    <!-- 根据ID更新泵站信息 -->
    <update id="updatePumpingStationById" parameterType="com.example.demo.pojo.entity.facility.PumpingStation">
        UPDATE pumping_stations
        <set>
            <if test="name != null">name = #{name},</if>
            <if test="stationCode != null">station_code = #{stationCode},</if>
            <if test="stationType != null">station_type = #{stationType},</if>
            <if test="waterProject != null">water_project = #{waterProject},</if>
            <if test="waterCompany != null">water_company = #{waterCompany},</if>
            <if test="longitude != null">longitude = #{longitude},</if>
            <if test="latitude != null">latitude = #{latitude},</if>
            <if test="address != null">address = #{address},</if>
            <if test="operationMode != null">operation_mode = #{operationMode},</if>
            <if test="unitCount != null">unit_count = #{unitCount},</if>
            <if test="designScale != null">design_scale = #{designScale},</if>
            <if test="installedCapacity != null">installed_capacity = #{installedCapacity},</if>
            <if test="liftHead != null">lift_head = #{liftHead},</if>
            <if test="establishmentDate != null">establishment_date = #{establishmentDate},</if>
            <if test="updatedAt != null">updated_at = #{updatedAt},</if>
            <if test="deletedAt != null">deleted_at = #{deletedAt}</if>
        </set>
        WHERE id = #{id}
    </update>

</mapper>
