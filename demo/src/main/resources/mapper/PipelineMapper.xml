<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demo.mapper.PipelineMapper">



    <!-- 分页查询管道信息列表（基础信息）- 用于PageHelper分页 -->
    <select id="selectPipelinePage" resultType="com.example.demo.pojo.entity.facility.Pipeline">
        SELECT *
        FROM pipelines
        WHERE deleted_at IS NULL
        <if test="keyword != null and keyword != ''">
            AND (name LIKE CONCAT('%', #{keyword}, '%')
            OR pipeline_code LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        <if test="pipelineType != null and pipelineType != ''">
            AND pipeline_type = #{pipelineType}
        </if>
        ORDER BY created_at DESC
    </select>

    <!-- 根据ID查询管道信息详情（基础信息） -->
    <select id="selectPipelineById" resultType="com.example.demo.pojo.entity.facility.Pipeline">
        SELECT *
        FROM pipelines
        WHERE id = #{id} AND deleted_at IS NULL
    </select>

    <!-- 查询管道类型名称 -->
    <select id="selectPipelineTypeNameByPipelineId" resultType="java.lang.String">
        SELECT dict_data.data_label
        FROM pipelines
        LEFT JOIN dict_data ON pipelines.pipeline_type = dict_data.data_value
        AND dict_data.type_id = (SELECT id FROM dict_types WHERE type_code = 'pipeline_type' AND deleted_at IS NULL)
        AND dict_data.deleted_at IS NULL
        WHERE pipelines.id = #{pipelineId} AND pipelines.deleted_at IS NULL
    </select>

    <!-- 检查管道编码是否存在 -->
    <select id="existsByPipelineCode" resultType="boolean">
        SELECT COUNT(*) > 0 FROM pipelines
        WHERE pipeline_code = #{pipelineCode}
        <if test="excludeId != null">
            AND id != #{excludeId}
        </if>
        AND deleted_at IS NULL
    </select>

    <!-- 获取所有可用的管道信息（用于下拉选择） -->
    <select id="selectAvailablePipelines" resultType="com.example.demo.pojo.entity.facility.Pipeline">
        SELECT id, pipeline_code, name FROM pipelines
        WHERE deleted_at IS NULL
        ORDER BY name
    </select>

    <!-- 统计管道信息总数 -->
    <select id="countTotal" resultType="long">
        SELECT COUNT(*) FROM pipelines WHERE deleted_at IS NULL
    </select>

</mapper>
