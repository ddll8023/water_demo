<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demo.mapper.ManagementInfoMapper">

    <!-- 获取部门树形结构 -->
    <select id="selectDepartmentTree" resultType="com.example.demo.pojo.entity.system.Department">
        SELECT *
        FROM departments
        WHERE deleted_at IS NULL
        ORDER BY parent_id ASC, created_at ASC
    </select>

    <!-- 根据ID查询部门详情（基础信息） -->
    <select id="selectDepartmentWithDetails" resultType="com.example.demo.pojo.entity.system.Department">
        SELECT *
        FROM departments
        WHERE id = #{id}
          AND deleted_at IS NULL
    </select>

    <!-- 查询父部门名称 -->
    <select id="selectParentNameByDepartmentId" resultType="java.lang.String">
        SELECT pd.name
        FROM departments d
                 LEFT JOIN departments pd ON d.parent_id = pd.id
        WHERE d.id = #{departmentId}
          AND pd.deleted_at IS NULL
    </select>

    <!-- 查询区域名称 -->
    <select id="selectRegionNameByDepartmentId" resultType="java.lang.String">
        SELECT r.name
        FROM departments d
                 LEFT JOIN regions r ON d.region_id = r.id
        WHERE d.id = #{departmentId}
    </select>

    <!-- 获取子部门列表 -->
    <select id="selectChildDepartments" resultType="com.example.demo.pojo.entity.system.Department">
        SELECT *
        FROM departments
        WHERE parent_id = #{parentId}
          AND deleted_at IS NULL
        ORDER BY created_at ASC
    </select>

    <!-- 分页查询人员信息列表 -->
    <select id="selectPersonnelPage" resultType="com.example.demo.pojo.entity.system.Personnel">
        SELECT * FROM personnel
        WHERE deleted_at IS NULL
        <if test="name != null and name != ''">
            AND name LIKE CONCAT('%', #{name}, '%')
        </if>
        <if test="departmentId != null">
            AND department_id = #{departmentId}
        </if>
        <if test="positionId != null">
            AND position_id = #{positionId}
        </if>
        ORDER BY created_at DESC
    </select>

    <!-- 查询符合条件的人员记录总数 -->
    <select id="countPersonnel" resultType="int">
        SELECT
        COUNT(1)
        FROM
        personnel p
        WHERE
        p.deleted_at IS NULL
        <if test="name != null and name != ''">
            AND p.name LIKE CONCAT('%', #{name}, '%')
        </if>
        <if test="departmentId != null">
            AND p.department_id = #{departmentId}
        </if>
        <if test="positionId != null">
            AND p.position_id = #{positionId}
        </if>
    </select>

    <!-- 插入人员记录 -->
    <insert id="insertPersonnel" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO personnel (name,
                               phone,
                               email,
                               position_id,
                               department_id,
                               user_id,
                               employee_no,
                               hire_date,
                               work_responsibilities,
                               created_at,
                               updated_at)
        VALUES (#{name},
                #{phone},
                #{email},
                #{positionId},
                #{departmentId},
                #{userId},
                #{employeeNo},
                #{hireDate},
                #{workResponsibilities},
                #{createdAt},
                #{updatedAt})
    </insert>

    <!-- 更新人员记录 -->
    <update id="updatePersonnel">
        UPDATE personnel
        SET
        <if test="name != null">name = #{name},</if>
        <if test="phone != null">phone = #{phone},</if>
        <if test="email != null">email = #{email},</if>
        <if test="positionId != null">position_id = #{positionId},</if>
        <if test="departmentId != null">department_id = #{departmentId},</if>
        <if test="userId != null">user_id = #{userId},</if>
        <if test="employeeNo != null">employee_no = #{employeeNo},</if>
        <if test="hireDate != null">hire_date = #{hireDate},</if>
        <if test="workResponsibilities != null">work_responsibilities = #{workResponsibilities},</if>
        <if test="updatedAt != null">updated_at = #{updatedAt}</if>
        WHERE
        id = #{id} AND deleted_at IS NULL
    </update>

    <!-- 根据ID查询人员信息 -->
    <select id="selectPersonnelById" resultType="com.example.demo.pojo.entity.system.Personnel">
        SELECT *
        FROM personnel
        WHERE id = #{id}
          AND deleted_at IS NULL
    </select>

    <!-- 根据用户ID查询人员ID（用于绑定巡检记录inspector_id） -->
    <select id="selectPersonnelIdByUserId" resultType="long">
        SELECT id
        FROM personnel
        WHERE user_id = #{userId}
          AND deleted_at IS NULL
        LIMIT 1
    </select>

    <!-- 统计部门下的人员数量 -->
    <select id="countPersonnelByDepartmentId" resultType="int">
        SELECT COUNT(1)
        FROM personnel
        WHERE department_id = #{departmentId}
          AND deleted_at IS NULL
    </select>
    <select id="selectDpartmentNameById" resultType="java.lang.String">
        select name
        from departments
        where id = #{departmentId}
    </select>
    <select id="selectPositionNameById" resultType="java.lang.String">
        select name
        from positions
        where id = #{positionId}
    </select>
    <select id="selectPersionnelByName" resultType="com.example.demo.pojo.entity.system.Personnel">
        select *
        from personnel
        where name = #{name}
          and deleted_at IS NULL
    </select>

    <!-- 更新部门信息 -->
    <update id="updateDepartment">
        UPDATE departments
        SET
        <if test="name != null">name = #{name},</if>
        parent_id = #{parentId},
        <if test="duty != null">duty = #{duty},</if>
        <if test="contact != null">contact = #{contact},</if>
        <if test="regionId != null">region_id = #{regionId},</if>
        <if test="isActive != null">is_active = #{isActive},</if>
        <if test="createdAt != null">created_at = #{createdAt},</if>
        <if test="updatedAt != null">updated_at = #{updatedAt}</if>
        WHERE
        id = #{id} AND deleted_at IS NULL
    </update>
</mapper> 