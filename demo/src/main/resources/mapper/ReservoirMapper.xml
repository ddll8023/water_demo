<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demo.mapper.ReservoirMapper">

    <!-- 查询水库列表（基础信息）- 用于PageHelper分页 -->
    <select id="selectReservoirList" resultType="com.example.demo.pojo.entity.facility.Reservoir">
        SELECT *
        FROM reservoirs
        WHERE deleted_at IS NULL
        <if test="keyword != null and keyword != ''">
            AND name LIKE CONCAT('%', #{keyword}, '%')
        </if>
        ORDER BY created_at DESC
    </select>

    <!-- 查询工程等级名称 -->
    <select id="selectEngineeringGradeNameByReservoirId" resultType="java.lang.String">
        SELECT dict_data.data_label
        FROM reservoirs
        LEFT JOIN dict_data ON reservoirs.engineering_grade = dict_data.data_value
        AND dict_data.type_id = (SELECT id FROM dict_types WHERE type_code = 'engineering_grade' AND deleted_at IS NULL)
        AND dict_data.deleted_at IS NULL
        WHERE reservoirs.id = #{reservoirId} AND reservoirs.deleted_at IS NULL
    </select>

    <!-- 查询工程规模名称 -->
    <select id="selectEngineeringScaleNameByReservoirId" resultType="java.lang.String">
        SELECT dict_data.data_label
        FROM reservoirs
        LEFT JOIN dict_data ON reservoirs.engineering_scale = dict_data.data_value
        AND dict_data.type_id = (SELECT id FROM dict_types WHERE type_code = 'engineering_scale' AND deleted_at IS NULL)
        AND dict_data.deleted_at IS NULL
        WHERE reservoirs.id = #{reservoirId} AND reservoirs.deleted_at IS NULL
    </select>

    <!-- 根据ID查询水库详情（基础信息） -->
    <select id="selectReservoirById" resultType="com.example.demo.pojo.entity.facility.Reservoir">
        SELECT *
        FROM reservoirs
        WHERE id = #{id} AND deleted_at IS NULL
    </select>

    <!-- 检查水库编码是否存在 -->
    <select id="existsByReservoirCode" resultType="boolean">
        SELECT COUNT(1) FROM reservoirs WHERE reservoir_code = #{reservoirCode} AND deleted_at IS NULL
        <if test="excludeId != null">AND id != #{excludeId}</if>
    </select>

    <!-- 检查水库名称是否存在 -->
    <select id="existsByName" resultType="boolean">
        SELECT COUNT(1) FROM reservoirs WHERE name = #{name} AND deleted_at IS NULL
        <if test="excludeId != null">AND id != #{excludeId}</if>
    </select>

    <!-- 检查注册登记号是否存在 -->
    <select id="existsByRegistrationNo" resultType="boolean">
        SELECT COUNT(1) FROM reservoirs WHERE registration_no = #{registrationNo} AND deleted_at IS NULL
        <if test="excludeId != null">AND id != #{excludeId}</if>
    </select>

    <!-- 获取所有可用水库（用于下拉选择） -->
    <select id="selectAvailableReservoirs" resultType="com.example.demo.pojo.entity.facility.Reservoir">
        SELECT id, name, reservoir_code FROM reservoirs
        WHERE deleted_at IS NULL
        ORDER BY name ASC
    </select>

    <!-- 统计水库总数 -->
    <select id="countTotal" resultType="long">
        SELECT COUNT(1) FROM reservoirs WHERE deleted_at IS NULL
    </select>

    <!-- 根据工程等级统计数量 -->
    <select id="countByEngineeringGrade" resultType="long">
        SELECT COUNT(1) FROM reservoirs WHERE engineering_grade = #{engineeringGrade} AND deleted_at IS NULL
    </select>

</mapper>
