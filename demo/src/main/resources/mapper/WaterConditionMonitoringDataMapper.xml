<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demo.mapper.WaterConditionMonitoringDataMapper">

    <!-- 分页查询水情监测数据 -->
    <select id="pageWaterConditionMonitoringData" resultType="com.example.demo.dto.monitoring.WaterConditionMonitoringDataResponseDTO">
        SELECT
            reservoir_monitoring_data.id,
            reservoir_monitoring_data.station_id,
            monitoring_stations.name AS station_name,
            reservoir_monitoring_data.monitoring_time,
            reservoir_monitoring_data.water_level,
            reservoir_monitoring_data.storage_capacity,
            reservoir_monitoring_data.flood_limit_diff,
            reservoir_monitoring_data.inflow,
            reservoir_monitoring_data.outflow,
            reservoir_monitoring_data.data_quality,
            COALESCE(dq.data_label, '未知') AS data_quality_text,
            reservoir_monitoring_data.collection_method,
            COALESCE(cm.data_label, '未知') AS collection_method_text,
            reservoir_monitoring_data.data_source,
            reservoir_monitoring_data.remark
        FROM
            reservoir_monitoring_data
        LEFT JOIN
            monitoring_stations ON reservoir_monitoring_data.station_id = monitoring_stations.id
        LEFT JOIN dict_data dq ON CAST(reservoir_monitoring_data.data_quality AS CHAR) COLLATE utf8mb4_unicode_ci = dq.data_value COLLATE utf8mb4_unicode_ci
            AND dq.type_id = (SELECT id FROM dict_types WHERE type_code = 'data_quality' LIMIT 1)
            AND dq.is_active = 1 AND dq.deleted_at IS NULL
        LEFT JOIN dict_data cm ON reservoir_monitoring_data.collection_method COLLATE utf8mb4_unicode_ci = cm.data_value COLLATE utf8mb4_unicode_ci
            AND cm.type_id = (SELECT id FROM dict_types WHERE type_code = 'collection_method' LIMIT 1)
            AND cm.is_active = 1 AND cm.deleted_at IS NULL
        WHERE
            reservoir_monitoring_data.deleted_at IS NULL
            <if test="stationId != null">
                AND reservoir_monitoring_data.station_id = #{stationId}
            </if>
            <if test="stationName != null and stationName != ''">
                AND monitoring_stations.name LIKE CONCAT('%', #{stationName}, '%')
            </if>
            <if test="startTime != null and startTime != ''">
                AND reservoir_monitoring_data.monitoring_time >= #{startTime}
            </if>
            <if test="endTime != null and endTime != ''">
                AND reservoir_monitoring_data.monitoring_time &lt;= #{endTime}
            </if>
            <if test="dataQuality != null">
                AND reservoir_monitoring_data.data_quality = #{dataQuality}
            </if>
        ORDER BY
            reservoir_monitoring_data.monitoring_time DESC
    </select>

</mapper>
